<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Dot Density | ArcGIS & Calcite</title>

  <!-- Load Calcite Components -->
  <script type="module" src="https://js.arcgis.com/calcite-components/3.0.3/calcite.esm.js"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/3.0.3/calcite.css">

  <!-- Load ArcGIS -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/dark/main.css">
  <script src="https://js.arcgis.com/4.32/"></script>

  <!-- Load ArcGIS Map Components -->
  <script type="module" src="https://js.arcgis.com/map-components/4.32/arcgis-map-components.esm.js"></script>

  <style>
    html, body { padding: 0; margin: 0; height: 100%; width: 100%; }
    #search-container {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      padding: 10px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  </style>
</head>
<body>

  <!-- ArcGIS Map and Zoom Controls -->
  <arcgis-map id="map" item-id="f1f9ac92570d4377ae21aca0958105cb">
    <arcgis-zoom position="top-left"></arcgis-zoom>
    <arcgis-expand position="top-left" group="top-left">
      <arcgis-legend></arcgis-legend>
    </arcgis-expand>
  </arcgis-map>

  <!-- Calcite Search Bar -->
  <div id="search-container">
    <calcite-combobox id="search-box" placeholder="Search Use Type..." selectionMode ="single"></calcite-combobox>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("üöÄ Script Loaded!");

  require(["esri/layers/FeatureLayer"], (FeatureLayer) => {
    console.log("‚úÖ ArcGIS Modules Loaded");

    const mapServiceUrl = "https://maps.trpa.org/server/rest/services/Zoning/MapServer";
    const tableLayer = new FeatureLayer({
      url: `${mapServiceUrl}/6`,
      outFields: ["Use_Type", "zoning_id"]
    });

    console.log("‚úÖ FeatureLayer Created:", tableLayer);

    tableLayer.load().then(() => {
      console.log("‚úÖ Table layer loaded!");
      getUniqueValues(tableLayer);
    });

    function getUniqueValues(tableLayer) {
      console.log("üîç Fetching unique values...");
      const query = tableLayer.createQuery();
      query.where = "1=1";
      query.outFields = ["Use_Type"];
      query.returnDistinctValues = true;
      

      tableLayer.queryFeatures(query).then((results) => {
        console.log("‚úÖ Query Results:", results);
        const uniqueValues = new Set(results.features.map(f => f.attributes.Use_Type).filter(Boolean));

        console.log("‚úÖ Unique Values Found:", uniqueValues);
        populateSearch([...uniqueValues]);
      }).catch(error => console.error("‚ùå Query Error:", error));
    }

    function populateSearch(values) {
      console.log("üí† Populating search box...");
      const searchBox = document.getElementById("search-box");
      searchBox.innerHTML = "";

      values.forEach((itemvalue) => {
        const item = document.createElement("calcite-combobox-item");
        item.value = itemvalue.trim();
        item.heading = itemvalue.trim();
        searchBox.appendChild(item);
      });

      console.log("‚úÖ Search Box Populated:", values);
    }
        // üî• Directly find the ArcGIS Map Component
    const arcgisMap = document.querySelector("arcgis-map");
    // üî• Keep this event listener the same ‚Äì your map is already working!
    document.getElementById("search-box").addEventListener("calciteComboboxChange", async (event) => {
      const selectedValue = event.target.value;
       // üî• Get the view from the ArcGIS Map Component (NO `await`, NO `whenLayerView`)
       const view = arcgisMap.view;
      const planningLocalPlanLayer = view.map.layers.find(layer => layer.title === "District");
    if (!planningLocalPlanLayer) {
    console.error("‚ùå Planning Local Plan layer not found.");
    return;
    }
      console.log("üîç Selected Use_Type:", selectedValue);
      if (!selectedValue) {planningLocalPlanLayer.featureEffect = null;
        console.log("üîÑ Reset Map Styling");
        return;}
      const query = tableLayer.createQuery();
      query.where = `Use_Type = '${selectedValue}'`;
      query.outFields = ["zoning_id"];

      try {
        const results = await tableLayer.queryFeatures(query);
        const zoningIds = results.features.map(f => f.attributes.zoning_id);
        console.log("‚úÖ Found Zoning IDs:", zoningIds);

        if (!zoningIds.length) {
          console.warn("‚ö† No matching zones found!");
          return;
        }

            
    if (!view) {
    console.error("‚ùå Map View not found.");
    return;
    }
    // Get the correct layer **without waiting**
    const planningLocalPlanLayer = view.map.layers.find(layer => layer.title === "District");
    if (!planningLocalPlanLayer) {
    console.error("‚ùå Planning Local Plan layer not found.");
    return;
    }

    // Apply the effect **directly**
    planningLocalPlanLayer.featureEffect = {
    filter: { where: `ZONING_ID IN ('${zoningIds.join("','")}')` },
    includedEffect: "bloom(1.5) drop-shadow(3px 3px 6px rgba(0,255,0,0.5)) brightness(1.2) saturate(1.5)",
    excludedEffect: "grayscale(90%) opacity(30%)"
    };

    console.log("üéØ Effect Applied to Layer");

    } catch (error) {
    console.error("‚ùå Query Error:", error);
    }
});
});
});
  </script>

</body>
</html>
