<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Dot Density | Sample | ArcGIS Maps SDK for JavaScript 4.32</title>

  <!-- Load Calcite Components -->
  <script type="module" src="https://js.arcgis.com/calcite-components/3.0.3/calcite.esm.js"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/3.0.3/calcite.css">

  <!-- Load ArcGIS Maps SDK -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/dark/main.css">
  <script src="https://js.arcgis.com/4.32/"></script>

  <!-- Load ArcGIS Map Components -->
  <script type="module" src="https://js.arcgis.com/map-components/4.32/arcgis-map-components.esm.js"></script>

  <style>
    html, body {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    #chip-container {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      padding: 10px;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
  </style>
</head>
<body>

  <arcgis-map id="map" item-id="f1f9ac92570d4377ae21aca0958105cb">
    <arcgis-zoom position="top-left"></arcgis-zoom>
    <arcgis-expand position="top-left" group="top-left">
      <arcgis-legend></arcgis-legend>
    </arcgis-expand>
    
  </arcgis-map>

  <!-- Container for Calcite Chips -->
  <div id="chip-container"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const map = document.querySelector("#map");
      const chipContainer = document.getElementById("chip-container");

      

      // Wait for the map's view to be ready
      map.addEventListener("arcgisViewReadyChange", (event) => {
        if (event.detail?.view) {
          console.log("Map view is ready!");
          const view = event.detail.view;
          const mapServiceUrl = "https://maps.trpa.org/server/rest/services/Zoning/MapServer"; // ðŸ”¹ Replace with your actual Map Service URL
          const tableLayer = new esri.layers.FeatureLayer({
            url: `${mapServiceUrl}/6`, // ðŸ”¹ Update with your table's correct index
            outFields: ["Use_Type"]
          });

          // Function to get unique values from the "Permissible Uses" field
          function getUniqueValues() {
            const query = tableLayer.createQuery();
            query.where = "1=1";  // Get all records
            query.outFields = ["Use_Type"];
            query.returnDistinctValues = true;

            tableLayer.queryFeatures(query).then((results) => {
              const uniqueValues = new Set();

              results.features.forEach((feature) => {
                const value = feature.attributes.Permissible_Uses;
                if (value) {
                  uniqueValues.add(value);
                }
              });

              createChips([...uniqueValues]);
            }).catch((error) => console.error("Error fetching values:", error));
          }

          // Function to create Calcite Chips
          function createChips(values) {
            chipContainer.innerHTML = ""; // Clear existing chips

            values.forEach((value) => {
              const chip = document.createElement("calcite-chip");
              chip.textContent = value;
              chip.value = value;
              chip.removable = false;
              chip.addEventListener("click", () => filterMap(value));
              chipContainer.appendChild(chip);
            });
          }

          // Function to filter the map based on the selected chip
          function filterMap(selectedValue) {
            tableLayer.definitionExpression = `Permissible_Uses = '${selectedValue}'`;
          }

          // Add the table layer to the map
          view.map.add(tableLayer);

          // Wait for the table layer to load and then get unique values
          tableLayer.when(() => {
            console.log("Table layer loaded!");
            getUniqueValues();
          });

          
        }
      });
    });
  </script>

</body>
</html>
